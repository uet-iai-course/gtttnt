<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Interactive PDF Slideshow</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --accent:#7c3aed; --muted:#9aa4b2; --glass: rgba(255,255,255,0.03);
      --radius:14px;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071026 0%, #081426 60%);color:#e6eef6}
    .app{display:flex;height:100vh;gap:18px;padding:18px;box-sizing:border-box}

    /* sidebar */
    .sidebar{width:300px;background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 6px 20px rgba(2,6,23,0.6);flex-shrink:0;transition:all .3s}
    .sidebar.hidden{display:none;}
    .brand{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#0ea5a0);display:flex;align-items:center;justify-content:center;font-weight:700}
    .brand h1{font-size:16px;margin:0}
    .list{margin-top:8px;max-height:58vh;overflow:auto;padding-right:8px}
    .pdf-item{padding:10px;border-radius:10px;cursor:pointer;margin-bottom:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);}
    .pdf-item.active{background:linear-gradient(90deg, rgba(124,58,237,0.12), rgba(14,165,160,0.06));box-shadow:0 6px 18px rgba(12,18,32,0.6)}
    .controls{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    .btn{background:var(--glass);border:none;padding:10px 12px;border-radius:10px;color:var(--muted);cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--accent),#06b6d4);color:white}
    .small{padding:8px}

    /* main view */
    .main{flex:1;display:flex;flex-direction:column;gap:12px}
    .stage{flex:1;background:rgba(255,255,255,0.02);border-radius:12px;padding:12px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
    .slide-canvas{max-width:calc(100% - 120px);max-height:calc(100% - 80px);box-shadow:0 10px 30px rgba(2,6,23,0.6);border-radius:8px;background:white}
    .nav-left,.nav-right{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.35);width:56px;height:56px;border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .nav-left{left:18px}
    .nav-right{right:18px}
    .footer{display:flex;align-items:center;gap:12px;justify-content:space-between}

    /* overlay panels */
    .panel{
      position:fixed;
      top:50%; left:50%;
      transform:translate(-50%,-50%);
      width:720px;
      max-width:90%;
      max-height:80vh;
      background:var(--card);
      border-radius:12px;
      padding:12px;
      box-shadow:0 12px 40px rgba(2,8,26,0.6);
      display:flex;
      flex-direction:column;
      z-index:9999;
      transition:all .28s ease;
    }
    .panel.hidden{opacity:0;pointer-events:none;transform:translate(-50%,-40%) scale(.96)}
    .panel .header{display:flex;align-items:center;justify-content:space-between}
    .editor-area{flex:1;display:flex;gap:8px;margin-top:8px}
    #editor{flex:1;border-radius:8px;overflow:hidden}
    .output{width:250px;background:#02111a;border-radius:8px;padding:8px;overflow-y:auto;overflow-x:hidden}
	button.hidden{display:none}

    .webview {
      position:absolute;
      inset:0;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.05);
      display:none;
      z-index:5;
    }
    .webview iframe {
      width:100%;
      height:100%;
      border:0;
      border-radius:10px;
    }
    .webview.visible{display:block}

    /* fullscreen slide lớn hơn nhưng vẫn thấy nút */
    .stage:fullscreen .slide-canvas {
      max-width:95%;
      max-height:95%;
    }
    .stage:fullscreen .nav-left,
    .stage:fullscreen .nav-right {
      z-index:10;
    }

    /* responsive */
    @media (max-width:980px){.sidebar{display:none}.panel{right:12px;left:12px;width:auto}}

    /* small helpers */
    .muted{color:var(--muted);font-size:13px}

    /* chat messages */
    .message{margin-bottom:10px;line-height:1.4;font-size:14px}
    .message.user{color:#38bdf8;text-align:right}
    .message.ai{color:#e6eef6;text-align:left}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand"><div class="logo">P</div><div><h1>PDF Presenter</h1><div class="muted">Beautiful, modern, GitHub Pages friendly</div></div></div>

      <div class="controls">
        <button id="toggleSidebar" class="btn small"><i class="fa-solid fa-bars"></i></button>
        <button id="toggle-webview" class="btn small"><i class="fa-solid fa-arrow-up-right-from-square"></i> Webview</button>
        <button id="toggle-editor" class="btn small"><i class="fa-solid fa-code"></i> Code</button>
        <button id="toggle-infer" class="btn small"><i class="fa-solid fa-robot"></i> Inference</button>
        <button id="fit" class="btn small">Fit</button>
      </div>

      <h3 style="margin-top:12px;margin-bottom:6px">PDFs</h3>
      <div class="list" id="pdfListContainer"></div>

      <div style="margin-top:12px;display:flex;gap:8px;align-items:center;justify-content:space-between">
        <div class="muted">Usage</div>
        <div class="muted">← → to navigate</div>
      </div>
    </aside>

    <main class="main">
      <div class="stage" id="stage">
        <div id="webview" class="webview"><iframe id="webframe" sandbox="allow-same-origin allow-scripts allow-forms allow-modals"></iframe></div>

        <canvas id="pdf-canvas" class="slide-canvas"></canvas>

        <div class="nav-left" id="prevBtn" title="Previous"><i class="fa-solid fa-chevron-left" style="font-size:18px;color:white"></i></div>
        <div class="nav-right" id="nextBtn" title="Next"><i class="fa-solid fa-chevron-right" style="font-size:18px;color:white"></i></div>
      </div>

      <div class="footer">
        <div class="muted" id="pageIndicator">No PDF loaded</div>
        <div style="display:flex;gap:8px">
          <button id="downloadPdf" class="btn">Download</button>
          <button id="presentBtn" class="btn primary">Open presentation (index.html)</button>
        </div>
      </div>
    </main>
  </div>

  <!-- floating button khi sidebar ẩn -->
  <button id="openSidebarBtn" class="btn small hidden"
     style="position:fixed;top:18px;left:18px;z-index:10000">
    <i class="fa-solid fa-bars"></i>
  </button>

  <!-- overlay panels -->
  <div id="editorPanel" class="panel hidden">
    <div class="header"><div><strong>Code Runner (Python)</strong><div class="muted">Powered by Pyodide</div></div><div><button id="closeEditor" class="btn small">Close</button></div></div>
    <div class="editor-area">
      <div id="editor"># Write Python code here\nprint("Hello from Pyodide")</div>
      <div class="output"><strong>Output</strong><pre id="consoleOut" style="white-space:pre-wrap;font-family:monospace;margin-top:6px"></pre></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:8px"><button id="runCode" class="btn primary">Run</button><button id="clearOutput" class="btn">Clear</button></div>
  </div>

  <!-- Chat Inference -->
  <div id="inferencePanel" class="panel hidden">
    <div class="header"><div><strong>AI Chat</strong><div class="muted">Hỏi đáp về bài học</div></div><div><button id="closeInference" class="btn small">Close</button></div></div>

    <div id="chatMessages"
          style="flex:1;overflow-y:auto;padding:8px;margin-top:8px;
                background:#0b1220;border-radius:8px">
      <!-- chat messages append here -->
    </div>

    <div style="display:flex;gap:8px;margin-top:8px">
      <input id="chatInput" type="text" placeholder="Nhập câu hỏi..."
              style="flex:1;padding:8px;border-radius:8px;border:none;
                    background:#02111a;color:white"/>
      <button id="sendChat" class="btn primary">Send</button>
    </div>
  </div>

  <!-- dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ace.js"></script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <script>
    const pdfList = ["01_Python_01.pptx.pdf"];

    const pdfListContainer = document.getElementById('pdfListContainer');
    const canvas = document.getElementById('pdf-canvas');
    const ctx = canvas.getContext('2d');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const pageIndicator = document.getElementById('pageIndicator');
    const toggleWebviewBtn = document.getElementById('toggle-webview');
    const webview = document.getElementById('webview');
    const webframe = document.getElementById('webframe');
    const toggleEditorBtn = document.getElementById('toggle-editor');
    const editorPanel = document.getElementById('editorPanel');
    const runCodeBtn = document.getElementById('runCode');
    const closeEditorBtn = document.getElementById('closeEditor');
    const downloadPdfBtn = document.getElementById('downloadPdf');
    const toggleSidebarBtn = document.getElementById('toggleSidebar');
    const sidebar = document.querySelector('.sidebar');
    const fitBtn = document.getElementById('fit');
    const stage = document.getElementById('stage');

    const toggleInferBtn = document.getElementById('toggle-infer');
    const inferencePanel = document.getElementById('inferencePanel');
    const closeInferBtn = document.getElementById('closeInference');

    const openSidebarBtn = document.getElementById('openSidebarBtn');

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    let currentPdf = null;
    let currentPage = 1;
    let totalPages = 0;
    let scale = 1.2;
    let currentPdfName = '';

    async function renderPage(pageNum){
      if(!currentPdf) return;
      const page = await currentPdf.getPage(pageNum);
      const viewport = page.getViewport({scale});
      const maxW = window.innerWidth - 360;
      const maxH = window.innerHeight - 200;
      const wScale = maxW / viewport.width;
      const hScale = maxH / viewport.height;
      const fitScale = Math.min(wScale, hScale, 1.8);
      const finalScale = scale * fitScale;
      const vp = page.getViewport({scale: finalScale});
      canvas.width = Math.floor(vp.width);
      canvas.height = Math.floor(vp.height);
      canvas.style.width = vp.width + 'px';
      canvas.style.height = vp.height + 'px';
      const renderCtx = {canvasContext: ctx, viewport: vp};
      await page.render(renderCtx).promise;
      pageIndicator.innerText = `${currentPdfName} — ${pageNum}/${totalPages}`;
    }

    async function loadPdf(url){
      try{
        currentPdfName = url.split('/').pop();
        const loadingTask = pdfjsLib.getDocument(url);
        currentPdf = await loadingTask.promise;
        totalPages = currentPdf.numPages;
        currentPage = 1;
        await renderPage(currentPage);
      }catch(err){
        console.error('Load PDF error',err);
        alert('Không thể load PDF. Kiểm tra đường dẫn hoặc console.');
      }
    }

    prevBtn.addEventListener('click',async()=>{ if(!currentPdf) return; currentPage=Math.max(1,currentPage-1); await renderPage(currentPage); });
    nextBtn.addEventListener('click',async()=>{ if(!currentPdf) return; currentPage=Math.min(totalPages,currentPage+1); await renderPage(currentPage); });
    window.addEventListener('keydown',async(e)=>{ if(e.key==='ArrowLeft'){ e.preventDefault(); prevBtn.click(); } if(e.key==='ArrowRight'){ e.preventDefault(); nextBtn.click(); } if(e.key==='Escape'){ hidePanels(); } });

    fitBtn.addEventListener('click',async()=>{ if(stage.requestFullscreen){ await stage.requestFullscreen(); } });

    function renderPdfList(){
      pdfListContainer.innerHTML='';
      pdfList.forEach((p,idx)=>{
        const it = document.createElement('div');
        it.className='pdf-item';
        it.innerText = p;
        it.addEventListener('click',()=>{ document.querySelectorAll('.pdf-item').forEach(el=>el.classList.remove('active')); it.classList.add('active'); loadPdf(p); });
        pdfListContainer.appendChild(it);
      });
      if(pdfList.length===0){ pdfListContainer.innerHTML='<div class="muted">Chưa có pdf nào. Mở file và sửa biến <code>pdfList</code> trong mã.</div>'; }
    }

    toggleWebviewBtn.addEventListener('click',()=>{
      if(webview.classList.contains('visible')){
        webview.classList.remove('visible'); toggleWebviewBtn.classList.remove('primary');
      }else{
        webview.classList.add('visible'); toggleWebviewBtn.classList.add('primary'); webframe.src = 'https://google.com';
      }
    });

    const aceEditor = ace.edit('editor');
    aceEditor.setTheme('ace/theme/monokai');
    aceEditor.session.setMode('ace/mode/python');
    aceEditor.setOptions({fontSize:'13px',wrap:true});

    toggleEditorBtn.addEventListener('click',()=>{ if(editorPanel.classList.contains('hidden')){ editorPanel.classList.remove('hidden'); toggleEditorBtn.classList.add('primary'); }else{ editorPanel.classList.add('hidden'); toggleEditorBtn.classList.remove('primary'); } });
    closeEditorBtn.addEventListener('click',()=>{ editorPanel.classList.add('hidden'); toggleEditorBtn.classList.remove('primary'); });

    toggleInferBtn.addEventListener('click',()=>{ if(inferencePanel.classList.contains('hidden')){ inferencePanel.classList.remove('hidden'); toggleInferBtn.classList.add('primary'); }else{ inferencePanel.classList.add('hidden'); toggleInferBtn.classList.remove('primary'); } });
    closeInferBtn.addEventListener('click',()=>{ inferencePanel.classList.add('hidden'); toggleInferBtn.classList.remove('primary'); });

	toggleSidebarBtn.addEventListener('click',()=>{
	  sidebar.classList.toggle('hidden');
	  if(sidebar.classList.contains('hidden')){
		// chỉ mở khi sidebar ẩn
		openSidebarBtn.classList.remove('hidden');
	  }else{
		openSidebarBtn.classList.add('hidden');
	  }
	});

	openSidebarBtn.addEventListener('click',()=>{
	  if(sidebar.classList.contains('hidden')){   // chỉ mở nếu đang ẩn
		sidebar.classList.remove('hidden');
		openSidebarBtn.classList.add('hidden');
	  }
	});

    let pyodide=null;
    async function initPyodide(){ pyodide = await loadPyodide(); }
    initPyodide();

    runCodeBtn.addEventListener('click',async()=>{
      const code=aceEditor.getValue();
      const consoleOut=document.getElementById('consoleOut');
      consoleOut.textContent='';
      try{ let r = await pyodide.runPythonAsync(code); if(r!==undefined) consoleOut.textContent += r+'\n'; }
      catch(err){ consoleOut.textContent += err+'\n'; }
    });
    document.getElementById('clearOutput').addEventListener('click',()=>{ document.getElementById('consoleOut').textContent=''; });
    downloadPdfBtn.addEventListener('click',()=>{ if(!currentPdfName){alert('No PDF loaded');return;} window.open(currentPdfName,'_blank'); });

    renderPdfList();

    // --- Chat inference logic with streaming & markdown ---
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendChatBtn = document.getElementById('sendChat');
    let chatHistory = [];

    function appendMessage(role, content, isHtml=false){
      const div = document.createElement('div');
      div.className = 'message ' + role;
      if(isHtml){
        div.innerHTML = content;
      }else{
        div.textContent = content;
      }
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return div;
    }

    async function streamChat(){
  const q = chatInput.value.trim();
  if(!q) return;
  appendMessage('user', q);
  chatHistory.push({role:"user", content:q});
  chatInput.value='';

  const aiDiv = appendMessage('ai','', true);
  let aiBuffer = "";   // chứa text liên tục

  try{
    const resp = await fetch("https://openrouter.ai/api/v1/chat/completions",{
      method:"POST",
      headers:{
        "Authorization":"Bearer "+(window.OPENAI_API_KEY || "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")
      },
      body:JSON.stringify({
        model:"deepseek/deepseek-chat-v3.1:free",
        messages:chatHistory,
        stream:true
      })
    });

    if(!resp.body) throw new Error("No stream body");

    const reader = resp.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let buffer = "";

    while(true){
      const {done, value} = await reader.read();
      if(done) break;
      buffer += decoder.decode(value, {stream:true});

      const lines = buffer.split("\n");
      buffer = lines.pop();

      for(const line of lines){
        if(line.startsWith("data: ")){
          const dataStr = line.replace("data: ","").trim();
          if(dataStr === "[DONE]") continue;
          try{
            const data = JSON.parse(dataStr);
            const token = data.choices?.[0]?.delta?.content || "";
            if(token){
              aiBuffer += token;
              // luôn render lại toàn bộ markdown text
              aiDiv.innerHTML = marked.parse(aiBuffer);
              chatMessages.scrollTop = chatMessages.scrollHeight;
            }
          }catch(e){
            console.error("Parse error", e, line);
          }
        }
      }
    }

    chatHistory.push({role:"assistant", content:aiBuffer});
  }catch(err){
    aiDiv.textContent = "Error: " + err;
  }
}


    sendChatBtn.addEventListener('click', streamChat);
    chatInput.addEventListener('keydown',(e)=>{
      if(e.key==='Enter' && !e.shiftKey){
        e.preventDefault();
        streamChat();
      }
    });

    function hidePanels(){
      editorPanel.classList.add('hidden');
      inferencePanel.classList.add('hidden');
      toggleEditorBtn.classList.remove('primary');
      toggleInferBtn.classList.remove('primary');
    }
  </script>
</body>
</html>
